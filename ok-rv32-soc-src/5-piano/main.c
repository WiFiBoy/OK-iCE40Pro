/*
 * Melody Example (on 32bit RISC-V core, picosoc)
 * Jan-2-21 tklua@wifiboy.org
 */

#include "lcd.h"
#include "clkcnt.h"

// 51-note frequency table
uint32_t freq[]={436364, 411872, 388756, 366937, 346342, 326903, 308556, 291238, 
274892, 259463, 244901, 231156, 218182, 205936, 194378, 183468, 173171, 163452, 
154278, 145619, 137446, 129732, 122450, 115578, 109091, 102968, 97189, 91734, 
86586, 81726, 77139, 72809, 68723, 64866, 61225, 57789, 54545, 51484, 48594, 45867, 
43293, 40863, 38569, 36405, 34361, 32433, 30613, 28894, 27273, 25742, 24297};

uint8_t melody[]={23,22,0,21,18,0,15,13,0,12,11,0,0,23,0,0,11,0,0,0,0,0,23,0,16,
    20,0,23,0,0,16,20,0,23,15,19,23,27,0,25,0,0,0,0,0,0,23,0,14,18,0,23,0,0,14,18,
    0,23,0,0,14,18,0,23,17,20,21,27,0,25,0,0,0,0,0,27,28,0,27,28,0,25,0,0,28,27,0,25,
    23,0,22,23,0,20,0,0,17,18,0,20,21,0,20,21,0,15,0,0,20,18,0,16,0,0,0,0,0,0,0,0,0,
    0,0,0,16,0,20,0,0,0,23,0,0,25,0,28,0,0,0,0,0,0,25,0,0,16,18,0,20,18,0,20,18,
    0,13,0,0,18,0,0,13,18,13,18,13,18,13,18,0,0,0,0,0,0,20,18,0,20,18,0,20,
    0,0,25,0,0,23,25,0,23,20,0,18,16,0,20,0,0,11,16,11,16,11,16,11,16,20,0,
    0,0,23,19,0,15,0,13,0,11,0,0,0,20,0,0,0,23,0,0,25,0,28,0,0,0,0,0,0,25,0,
    23,20,16,18,20,18,0,20,18,0,13,0,0,18,0,0,13,18,13,18,13,18,13,18,0,0,0,
    0,20,18,0,20,18,0,20,0,0,25,0,0,23,25,0,23,25,0,23,20,0,16,0,0,0,0,0,10,
    11,0,12,13,0,16,0,0,0,0,0,16,0,0,0,16,0,20,0,0,21,19,0,20,21,0,19,20,0,
    27,0,0,0,24,0,0,21,0,0,20,0,18,20,18,16,15,0,16,18,0,16,15,0,16,0,0,0,0,
    0,16,15,0,0,16,0,0,0,0,18,0,0,0,17,0,0,18,0,25,0,0,0,22,0,0,23,0,0,25,0,
    0,27,0,0,0,0,0,25,0,0,0,0,0,24,0,0,0,0,0,23,0,18,15,0,11,0,0,0,0,0,0,0,0};

#define KEY_A   1
#define KEY_B   2
#define KEY_R   4
#define KEY_L   8
#define KEY_D   16
#define KEY_U   32
#define KEY_M   64

uint8_t get_key(void)
{
    return(uint8_t)((127-(gp_in & 0x7F)));
}

void main()
{
    uint8_t key;
    
	lcd_init();                     // initialize LCD
	lcd_fillScreen(COLOR_BLACK);    // clear screen, check lcd.h for colors
	lcd_drawStr(28, 30, "Piano Demo V1", COLOR_GREEN, COLOR_BLACK);
	lcd_emptyRect(24, 70, 112, 24, COLOR_RED);
    lcd_drawStr(32, 78, "OK-iCE40 Pro", COLOR_YELLOW, COLOR_BLACK);
	lcd_on();                       // turn on LCD backlight 
	
	while(1) {
	    key = get_key();
	    if (key & KEY_L) spkr = freq[20];
	    else if (key & KEY_U) spkr = freq[22];
	    else if (key & KEY_D) spkr = freq[24];
	    else if (key & KEY_R) spkr = freq[25];
	    else if (key & KEY_B) spkr = freq[27];
	    else if (key & KEY_A) spkr = freq[29];
	    else if (key & KEY_M) spkr = freq[30];
	    
	    clkcnt_delayus(400);
	}
}
